name: Build & Push API Image to DockerHub

on:
    push:
        branches:
            - main
    workflow_dispatch:

env:
    IMAGE_NAME: pakjkwan/labzang-api
    CONTAINER_NAME: labzang-api
    ENV_FILE_PATH: /home/ubuntu/api/.env
    HOST_PORT: "8080"
    CONTAINER_PORT: "8080"

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout source
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to DockerHub
              uses: docker/login-action@v3
              with:
                  registry: docker.io
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  tags: |
                      ${{ env.IMAGE_NAME }}:latest
                      ${{ env.IMAGE_NAME }}:${{ github.sha }}

    deploy-to-ec2:
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
            - name: Write SSH key
              run: |
                  echo "${{ secrets.EC2_SSH_KEY_B64 }}" | base64 -d > /tmp/spring.pem
                  chmod 600 /tmp/spring.pem
            - name: Deploy to EC2
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USERNAME }}
                  key_path: /tmp/spring.pem
                  script: |
                      set -e

                      IMAGE="${{ env.IMAGE_NAME }}:latest"
                      CONTAINER="${{ env.CONTAINER_NAME }}"
                      HOST_PORT="${{ env.HOST_PORT }}"
                      CONTAINER_PORT="${{ env.CONTAINER_PORT }}"
                      ENV_FILE="${{ env.ENV_FILE_PATH }}"

                      echo "==> Check env file: $ENV_FILE"
                      if [ ! -f "$ENV_FILE" ]; then
                        echo "ERROR: .env not found at $ENV_FILE"
                        exit 1
                      fi

                      echo "==> Stop/remove old container (ignore errors)"
                      docker stop "$CONTAINER" 2>/dev/null || true
                      docker rm "$CONTAINER" 2>/dev/null || true

                      echo "==> Pull latest image"
                      docker pull "$IMAGE"

                      echo "==> Run new container with env-file"
                      docker run -d --name "$CONTAINER" \
                        --restart unless-stopped \
                        --env-file "$ENV_FILE" \
                        -p "$HOST_PORT:$CONTAINER_PORT" \
                        "$IMAGE"

                      echo "==> docker ps / docker ps -a"
                      docker ps --filter "name=$CONTAINER" || true
                      docker ps -a --filter "name=$CONTAINER" || true

                      echo "==> Tail logs"
                      docker logs "$CONTAINER" --tail 120 || true

                      echo "==> Cleanup unused images"
                      docker image prune -f
